## Uniswap V3 概述

Uniswap V3 是一个基于以太坊虚拟机（EVM）实现的无监管自动做市商（AMM），于2021年5月上线。它允许用户在去中心化的交易所（DEX）上进行交易，无需中心化机构的支持。

Uniswap V3 是 Uniswap 的第三个版本，它与之前的版本相比，它引入了多项重大改进，旨在提高资金利用率、赋予流动性提供者更多控制能力、改进价格预言机的准确性和便利性，同时增加了更灵活的手续费结构。

Uniswap V3 的设计目标是提供一个安全、高效、易用的去中心化交易所，它的核心功能包括：
- 集中流动性
在 Uniswap V2 中，流动性提供者（LP）需在整个价格范围内（0 到∞）提供流动性。而 Uniswap V3 允许 LPs 在特定的价格区间内提供流动性，这提高了资金效率，使 LPs 能将资金集中在市场最活跃的价格区间，提升收益率。
- 多级费率结构
Uniswap V3 引入了多种不同的费用层级（0.05%、0.3%、1%）供 LPs 选择，以适应不同的市场条件和风险偏好。
  - 0.05%：稳定币对（如 USDC/USDT）。
  - 0.30%：主流代币对（如 ETH/USDC）。
  - 1%：高波动性代币对。
- 限价订单功能
LPs 在 V3 中可为其流动性设定特定价格区间。若资产价格超出此范围，其流动性就不会被用于交易，有助于降低无常损失。用户可以更精准地控制交易价格和时机，满足特定的交易策略需求。
- 改进的价格预言机
Uniswap V3 内置了高效的时间加权平均价格（TWAP）预言机，能够更精确地提供价格数据，这些数据可被其他 DeFi 协议使用，进一步增强了整个生态系统的互操作性。
- LP Token 改为不可互换的 NFT
在 Uniswap V3 中，流动性提供者的凭证从 ERC20 Token 改为 ERC721 NFT，每一次添加的流动性都基本是独一无二的，因此使用 NFT 来表示每个头寸（position）
- 自动路由
Uniswap V3 的交易功能会自动寻找最佳的交易路径，通过不同的交易对来最大化交易效率。例如，当在 ETH 和 USDC 之间进行交易时，Uniswap 可能会通过多个中间交易对来找到最具成本效益的路径，减少滑点并节省交易成本。

## 技术架构
Uniswap V3 的技术架构在 V2 的基础上进行了显著升级，引入了更复杂的智能合约设计和数学模型，以支持集中流动性、多费率等级和高级交易功能。

Uniswap V3 的技术架构包括以下主要组件：
- 核心合约
Uniswap V3 的核心合约包括 UniswapV3Factory、UniswapV3Pool、PositionManager 和 UniswapV3Router。

  **UniswapV3Factory**
  - 负责创建和管理交易对（Pairs）。
  - 每个交易对由单独的 UniswapV3Pool 合约实例管理。
  - 支持三种手续费等级（0.05%、0.30%、1%）。

  **UniswapV3Pool**
  - 每个交易对（如 ETH/USDC）对应一个独立的 Pool 合约。
  - 实现集中流动性逻辑，记录所有流动性头寸（Liquidity Positions）。
  - 处理交易、流动性添加/移除、手续费计算等核心功能。

  **NonfungiblePositionManager**
  - 将流动性头寸（LP Positions）表示为 NFT（ERC-721），方便用户管理。
  - 提供流动性增/删/查接口，并处理手续费提取。

  **UniswapV3Router**
  - 用户进行代币交换的入口，用户可以通过该模块完成代币的交换操作
  - 支持多路径路由，自动选择最优路径。
  - 支持链下计算，降低 Gas 成本。

- 流动性提供者（LP）合约
Uniswap V3 引入了流动性提供者（LP）合约，用于管理流动性池中的流动性。

- 预言机合约
Uniswap V3 内置了时间加权平均价格（TWAP）预言机，用于提供价格数据。

- 其他辅助合约
Uniswap V3 还引入了其他辅助合约，用于支持更复杂的交易和管理功能。
